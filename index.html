<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <!-- Keep existing head content unchanged -->
    <style>
        /* Add new empty state styles */
        .empty-state {
            @apply text-gray-400 text-center py-4 text-sm;
        }
        .empty-state i {
            @apply text-2xl mb-2 opacity-50;
        }
    </style>
</head>
<body>
    <!-- Keep all existing body content until the script section -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ... [keep all existing element definitions and setup code]

            // Modified formatRecommendations function with empty states
            function formatRecommendations(recommendations) {
                let html = '<div class="space-y-6">';

                // Medications Section
                html += `<div class="medication-card p-4 rounded-xl border border-amber-500/20">
                    <h3 class="text-lg font-semibold text-amber-400 mb-3">üíä Recommended Medications</h3>`;
                
                if (recommendations.medications?.length > 0) {
                    html += `<div class="space-y-4">${recommendations.medications.map(med => `
                        <div class="bg-gray-900/30 p-3 rounded-lg">
                            <div class="font-medium">${med.name}</div>
                            ${med.dosage ? `<div class="text-sm text-amber-300">${med.dosage}</div>` : ''}
                            ${med.purpose ? `<div class="text-sm text-gray-400 mt-1">${med.purpose}</div>` : ''}
                        </div>`).join('')}
                    </div>`;
                } else {
                    html += `<div class="empty-state">
                        <i class="fas fa-pills"></i>
                        <p>No medication recommendations available</p>
                    </div>`;
                }
                html += '</div>'; // Close medications section

                // Treatment Plan Section
                html += `<div class="bg-green-900/10 p-4 rounded-xl border border-green-500/20">
                    <h3 class="text-lg font-semibold text-green-400 mb-3">üè• Treatment Plan</h3>`;
                if (recommendations.treatments?.length > 0) {
                    html += `<ul class="list-disc pl-6 space-y-2">
                        ${recommendations.treatments.map(t => `<li>${t}</li>`).join('')}
                    </ul>`;
                } else {
                    html += `<div class="empty-state">
                        <i class="fas fa-procedures"></i>
                        <p>No treatment recommendations available</p>
                    </div>`;
                }
                html += '</div>';

                // Precautions Section
                html += `<div class="bg-red-900/10 p-4 rounded-xl border border-red-500/20">
                    <h3 class="text-lg font-semibold text-red-400 mb-3">‚ö†Ô∏è Important Precautions</h3>`;
                if (recommendations.precautions?.length > 0) {
                    html += `<ul class="list-disc pl-6 space-y-2">
                        ${recommendations.precautions.map(p => `<li>${p}</li>`).join('')}
                    </ul>`;
                } else {
                    html += `<div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>No specific precautions identified</p>
                    </div>`;
                }
                html += '</div>';

                // Follow-up Section
                html += `<div class="bg-blue-900/10 p-4 rounded-xl border border-blue-500/20">
                    <h3 class="text-lg font-semibold text-blue-400 mb-3">üìÖ Follow-up Protocol</h3>`;
                if (recommendations.follow_up?.length > 0) {
                    html += `<ul class="list-disc pl-6 space-y-2">
                        ${recommendations.follow_up.map(f => `<li>${f}</li>`).join('')}
                    </ul>`;
                } else {
                    html += `<div class="empty-state">
                        <i class="fas fa-calendar-check"></i>
                        <p>No follow-up recommendations available</p>
                    </div>`;
                }
                html += '</div>';

                html += '</div>'; // Close main container
                return html;
            }

            // Modified API handler with better error reporting
            elements.submitBtn.addEventListener('click', async () => {
                try {
                    // Clear previous results
                    elements.analysisContainer.innerHTML = '';
                    elements.recommendationContainer.innerHTML = '';
                    
                    // Validate inputs
                    if (!elements.upload.files[0] || !elements.queryInput.value.trim()) {
                        throw new Error('Please upload an image and enter a query');
                    }

                    // Show loading states
                    elements.analysisLoading.classList.remove('hidden');
                    elements.recommendationLoading.classList.remove('hidden');

                    const formData = new FormData();
                    formData.append('image', elements.upload.files[0]);
                    formData.append('query', elements.queryInput.value);

                    const response = await fetch('/upload_and_query', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Analysis failed');

                    // Display analysis
                    elements.analysisLoading.classList.add('hidden');
                    elements.analysisContainer.innerHTML = marked.parse(data.analysis);
                    
                    // Display recommendations with fallback
                    elements.recommendationLoading.classList.add('hidden');
                    const safeRecommendations = {
                        medications: data.recommendations?.medications || [],
                        treatments: data.recommendations?.treatments || [],
                        precautions: data.recommendations?.precautions || [],
                        follow_up: data.recommendations?.follow_up || []
                    };
                    elements.recommendationContainer.innerHTML = formatRecommendations(safeRecommendations);

                } catch (error) {
                    showError(error.message);
                    // Restore default messages if needed
                    if (!elements.analysisContainer.innerHTML) {
                        elements.analysisContainer.innerHTML = 
                            '<div class="text-gray-400 text-center py-4">Analysis failed - please try again</div>';
                    }
                    elements.recommendationContainer.innerHTML = 
                        '<div class="text-gray-400 text-center py-4">Recommendations unavailable - check analysis results</div>';
                } finally {
                    elements.analysisLoading.classList.add('hidden');
                    elements.recommendationLoading.classList.add('hidden');
                }
            });

            // Keep existing showError function and other utilities
        });
    </script>
</body>
</html>
